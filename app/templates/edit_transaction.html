{% extends "base.html" %}

{% block title %}編輯支出{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <h2>編輯支出紀錄 (ID: {{ transaction_id }})</h2>
        <a href="{{ url_for('petty_cash.transaction_detail', transaction_id=transaction_id) }}"
            class="btn btn-secondary">
            <i class="bi bi-x-lg"></i> 取消
        </a>
    </div>
    <hr>
    <form method="POST" action="" id="expenditure-form" novalidate>
        {{ form.hidden_tag() }}

        <div class="row mb-3">
            <div class="col-md-4">
                {{ form.application_date.label(class="form-label") }}
                {{ form.application_date(class="form-control") }}
            </div>
            <div class="col-md-4">
                {{ form.transaction_date.label(class="form-label") }}
                {{ form.transaction_date(class="form-control") }}
            </div>
            <div class="col-md-4">
                {{ form.erp_document_number.label(class="form-label") }}
                {{ form.erp_document_number(class="form-control") }}
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                {{ form.applicant_name.label(class="form-label") }}
                {{ form.applicant_name(class="form-control") }}
            </div>
            <div class="col-md-6">
                {{ form.description.label(class="form-label") }}
                {{ form.description(class="form-control") }}
            </div>
        </div>

        <div class="row mb-3 align-items-end">
            <div class="col-md-4">
                {{ form.tax_type.label(class="form-label") }}
                {{ form.tax_type(class="form-select") }}
            </div>
            <div class="col-md-8">
                {{ form.tax_calculation_method.label(class="form-label mb-2") }}
                <div>
                    {% for subfield in form.tax_calculation_method %}
                    <div class="form-check form-check-inline">
                        {{ subfield(class="form-check-input") }}
                        {{ subfield.label(class="form-check-label") }}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <hr>

        <h4>項目明細</h4>
        <div id="items-container">
            {% for item_form in form.items %}
            <div class="row item-row mb-2 align-items-center">
                <div style="display:none;">{{ item_form.hidden_tag() }}</div>
                <div class="col-md-4">{{ item_form.item_name(class="form-control") }}</div>
                <div class="col-md-2">{{ item_form.quantity(class="form-control") }}</div>
                <div class="col-md-2">{{ item_form.unit(class="form-control") }}</div>
                <div class="col-md-3">{{ item_form.unit_price(class="form-control") }}</div>
                <div class="col-md-1"><button type="button" class="btn btn-danger remove-item"><i
                            class="bi bi-x-circle"></i></button></div>
            </div>
            {% endfor %}
        </div>
        <button type="button" id="add-item" class="btn btn-outline-success mt-2">
            <i class="bi bi-plus-circle"></i> 新增一項明細
        </button>

        <hr>
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <input type="submit" value="儲存變更" class="btn btn-primary btn-lg">
        </div>
    </form>
</div>

<div id="item-template" style="display: none;">
    <div class="row item-row mb-2 align-items-center">
        <div class="col-md-4"><input type="text" name="items-__prefix__-item_name" class="form-control"
                placeholder="品名"></div>
        <div class="col-md-2"><input type="number" step="any" name="items-__prefix__-quantity" class="form-control"
                placeholder="數量"></div>
        <div class="col-md-2"><input type="text" name="items-__prefix__-unit" class="form-control"
                placeholder="單位 (個/張)"></div>
        <div class="col-md-3"><input type="number" step="any" name="items-__prefix__-unit_price" class="form-control"
                placeholder="單價"></div>
        <div class="col-md-1"><button type="button" class="btn btn-danger remove-item"><i
                    class="bi bi-x-circle"></i></button></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('add-item').addEventListener('click', function () {
            let index = document.querySelectorAll('.item-row').length;
            let template = document.getElementById('item-template').innerHTML;
            let newRow = template.replace(/__prefix__/g, index);
            document.getElementById('items-container').insertAdjacentHTML('beforeend', newRow);
        });

        document.getElementById('items-container').addEventListener('click', function (e) {
            if (e.target && e.target.closest('.remove-item')) {
                e.target.closest('.item-row').remove();
                updateIndices();
            }
        });

        function updateIndices() {
            let rows = document.querySelectorAll('.item-row');
            rows.forEach((row, index) => {
                row.querySelectorAll('input, select').forEach(input => {
                    if (input.name) {
                        input.name = input.name.replace(/items-\d+-/, 'items-' + index + '-');
                    }
                });
            });
        }
    });
</script>
{% endblock %}