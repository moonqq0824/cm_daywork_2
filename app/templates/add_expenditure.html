{% extends "base.html" %} {% block title %}新增支出{% endblock %} {% block
content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <h2>新增支出紀錄</h2>
        <a href="{{ url_for('petty_cash.index') }}" class="btn btn-secondary">
            <i class="bi bi-x-lg"></i> 取消
        </a>
    </div>
    <hr />
    <form method="POST" action="" id="expenditure-form" novalidate>
        {{ form.hidden_tag() }}

        <div class="row mb-3">
            <div class="col-md-4">
                {{ form.application_date.label(class="form-label") }} {{
                form.application_date(class="form-control") }}
            </div>
            <div class="col-md-4">
                {{ form.transaction_date.label(class="form-label") }} {{
                form.transaction_date(class="form-control") }}
            </div>
            <div class="col-md-4">
                {{ form.erp_document_number.label(class="form-label") }} {{
                form.erp_document_number(class="form-control") }}
            </div>
        </div>
        <div class="mb-3">
            {{ form.applicant_name.label(class="form-label") }} {{
            form.applicant_name(class="form-control", readonly=True) }}
            <div class="form-text">系統自動帶入登入者，不可變更。</div>
        </div>
        <div class="mb-3">
            {{ form.description.label(class="form-label") }} {{
            form.description(class="form-control", placeholder="例如：購買文具用品")
            }}
        </div>

        <div class="row mb-3 align-items-end">
            <div class="col-md-4">
                {{ form.tax_type.label(class="form-label") }} {{
                form.tax_type(class="form-select", id="tax_type_select") }}
            </div>
            <div class="col-md-8" id="tax_calculation_method_div" style="display: none">
                {{ form.tax_calculation_method.label(class="form-label mb-2") }}
                <div>
                    {% for subfield in form.tax_calculation_method %}
                    <div class="form-check form-check-inline">
                        {{ subfield(class="form-check-input") }} {{
                        subfield.label(class="form-check-label") }}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <hr />

        <div class="row gx-2 text-muted small mb-1">
            <div class="col-md-3">品名</div>
            <div class="col-md-1">數量</div>
            <div class="col-md-2">單位</div>
            <div class="col-md-2">單價</div>
            <div class="col-md-2">費用分類</div>
            <div class="col-md-1 text-end">小計</div>
            <div class="col-md-1"></div>
        </div>

        {# 在新增頁面，這裡一開始是空的，會由 JS 動態填入 #}
        <div id="items-container"></div>

        <button type="button" id="add-item" class="btn btn-outline-success mt-2">
            <i class="bi bi-plus-circle"></i> 新增一項明細
        </button>

        <hr />

        <div class="row justify-content-end">
            <div class="col-lg-5">
                <dl class="row text-end">
                    <dt class="col-sm-6">銷售額 (未稅)</dt>
                    <dd class="col-sm-6" id="display-subtotal">$ 0</dd>
                    <dt class="col-sm-6">稅額</dt>
                    <dd class="col-sm-6" id="display-tax">$ 0</dd>
                    <dt class="col-sm-6 fs-5">總金額</dt>
                    <dd class="col-sm-6 fs-5 fw-bold" id="display-total">$ 0</dd>
                </dl>
            </div>
        </div>

        <hr />

        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a href="{{ url_for('petty_cash.index') }}" class="btn btn-secondary btn-lg">取消</a>
            {{ form.submit(class="btn btn-primary btn-lg") }}
        </div>
    </form>
</div>

{# --- ▼▼▼ 這是動態新增明細時的 "模板" ▼▼▼ --- #}
<div id="item-template" style="display: none;">
    <div class="row gx-2 item-row mb-2 align-items-center">
        <div class="col-md-3">
            <input type="text" name="items-__prefix__-item_name" class="form-control item-name" required>
        </div>
        <div class="col-md-1">
            <input type="number" step="any" name="items-__prefix__-quantity" class="form-control item-quantity"
                required>
        </div>
        <div class="col-md-2">
            <input type="text" name="items-__prefix__-unit" class="form-control item-unit">
        </div>
        <div class="col-md-2">
            <input type="number" step="any" name="items-__prefix__-unit_price" class="form-control item-unit_price"
                required>
        </div>
        <div class="col-md-2">
            {# 這裡的 form.items[0] 只是為了讓 WTForms 能渲染出一個包含選項的 select 範本 #}
            {# JS 會在動態新增時，複製這些 options 到新的 select 中 #}
            {{ form.items[0].category_id(class="form-select item-category") }}
        </div>
        <div class="col-md-1">
            <input type="text" class="form-control item-subtotal text-end" readonly>
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-sm btn-danger remove-item">
                <i class="bi bi-x-circle"></i>
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
{# --- ▼▼▼ 同樣引用我們建立的 JS 檔案 ▼▼▼ --- #}
<script src="{{ url_for('static', filename='js/expenditure_form.js') }}"></script>
{% endblock %}